<?php
if(file_exists("install/index.php")){header("Location: install/index.php");exit;}
/*
RedixCMS 4.0
Главный файл, запускаемый в самом начале
*/

/* ПЕРВЫЙ БЛОК: ПОДГОТОВКА */
session_cache_limiter('nocache');
session_start(); // стартуем сессию

/* УСТАНОВКА ПРИ НЕОБХОДИМОСТИ */
if (file_exists('install.php')) {
	require_once('install.php');
	exit();
}

/* ВТОРОЙ БЛОК: ИНКЛУДЫ */
//подключаем файл конфига
require_once("_config.php");

//change language
if($_SERVER['HTTP_ACCEPT_LANGUAGE'] && !$_SESSION['choosed_lang'] && REQUEST_URI=='/' && sizeof($_LANGS)>1){$lang=strtolower(substr($_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2));if(!in_array($lang,$_LANGS)){$lang=$_LANGS[0];}header("Location: http://".HTTP_HOST.'/'.$lang.'/');$_SESSION['choosed_lang']=$lang;exit;}

//clearing mirrors.
/*if(HTTP_HOST=='...') {header("HTTP/1.1 301 Moved Permanently");header("Location: http://...".REQUEST_URI);exit;}*/

//подключаем файл глобальных функций
require_once("_system/_global_functions.php");
//подключаем файл пользовательских функций. Эти функции попадают в основной класс
require_once("_system/_core_user.php");
//подключаем файл работы с БД
require_once("_system/_db_".DB_TYPE.".php");
//подключаем файл главного класса
require_once("_system/_core_".CMS_VERSION.".php");
// подключаем файл главного класса
require_once(ADMINDIRNAME."/_system/_adm_core_".ADM_VERSION.".php");

/* ТРЕТИЙ БЛОК: ОПРЕДЕЛЕНИЕ ГЛОБАЛЬНЫХ ПЕРЕМЕННЫХ */
//определяем основной класс ядра
$core = new adm_core(ADMINDIRNAME);
//проверяет авторизацию пользователя
$core->login();
$core->prestart();

/* ЧЕТВЁРТЫЙ БЛОК: ФОРМИРОВАНИЕ СТРАНИЦЫ */
$core->core_go_proceedform();
$cache_data = $core->core_get_cachepage();
if($cache_data["cache"]) {
	//если выводим содержимое страницы из кэша, то записываем в TEXT HTML страницы и не выполняем блок ниже
	$_TEXT = $cache_data["data"];
} else {
	//начали запись в буфер
	ob_start();
	//Запуск вызываемого компонента
	$core->core_go_component();
	//Вызов нужного шаблона сайта
	$core->core_site_template();
	//получили содержимое буфера
	$_TEXT = ob_get_contents();
	//очистили буфер
	ob_end_clean ();
	//записали в кэш страницу
	$core->core_put_cachepage($_TEXT);
}

/* ПЯТЫЙ БЛОК: ЗАВЕРШЕНИЕ РАБОТЫ */
//выполняем голову
$core->core_go_header();
//выводим текст
$core->core_show_page($_TEXT);
//пишем статистику
$core->core_write_statistic();
//закрываем коннект к БД
$core->db_close();
echo "\n<!--redixCMS time2gen : ".$core->core_show_exec_time()."-->";
$core->core_debug(0);
?>